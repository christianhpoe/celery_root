<!--
SPDX-FileCopyrightText: 2026 Christian-Hauke Poensgen
SPDX-FileCopyrightText: 2026 Maximilian Dolling
SPDX-FileContributor: AUTHORS.md

SPDX-License-Identifier: BSD-3-Clause
-->

{% extends "base.html" %}
{% load static %}

{% block content %}
  <header class="page-section-header">
    <div>
      <p class="eyebrow">Task submit</p>
      <h2>Dispatch a task</h2>
      <p>Submit a task to the configured Celery broker.</p>
    </div>
  </header>

  <section>
    <form
      method="post"
      data-task-form
      data-task-select="task-name"
      data-args-input="task-args"
      data-kwargs-input="task-kwargs"
      data-param-container="task-params"
      data-param-hint="task-param-hint"
      data-queue-input="task-queue"
      data-json-toggle="task-use-json"
      data-json-fields="task-json-fields"
      data-param-card="task-param-card"
      data-schema-id="task-schema-data"
      data-schema-nested="false"
      data-task-options="static"
    >
      {% csrf_token %}
      <div class="filter-panel">
        <div>
          <label for="task-name">Task name</label>
          {% if task_names %}
            <input
              type="search"
              class="select-search"
              placeholder="Search tasks..."
              aria-label="Search tasks"
              data-select-search
              data-select-target="task-name"
            />
            <select id="task-name" name="task_name" required>
              <option value="">Select a task</option>
              {% for name in task_names %}
                <option value="{{ name }}">{{ name }}</option>
              {% endfor %}
            </select>
          {% else %}
            <p>No tasks discovered. Configure CELERY_ROOT_WORKERS.</p>
          {% endif %}
        </div>
        <div>
          <label for="task-queue">Queue (optional)</label>
          <input id="task-queue" name="queue" type="text" placeholder="default" />
        </div>
        <div>
          <label for="task-repeat">Repeat</label>
          <input id="task-repeat" name="repeat" type="number" min="1" max="100" value="1" />
        </div>
      </div>

      <div class="form-toggle">
        <label>
          <input type="checkbox" id="task-use-json" />
          Use raw JSON inputs instead
        </label>
        <span>Typed form auto-fills args/kwargs.</span>
      </div>

      <section class="detail-card" id="task-param-card">
        <h3>Task inputs</h3>
        <p class="detail-runtime" id="task-param-hint">Select a task to see its inputs.</p>
        <div id="task-params" class="task-param-grid"></div>
      </section>

      <section class="detail-card" id="task-json-fields">
        <h3>Advanced JSON</h3>
        <div class="filter-panel">
          <div>
            <label for="task-args">Args (JSON list)</label>
            <div class="json-editor-actions">
              <button class="btn ghost btn-sm" type="button" data-json-format="task-args">Format</button>
              <button class="btn ghost btn-sm" type="button" data-json-validate="task-args">Validate</button>
              <span class="json-editor-status" data-json-status="task-args" aria-live="polite"></span>
            </div>
            <textarea
              id="task-args"
              name="args"
              class="json-input"
              rows="6"
              placeholder="[1, 2, 3]"
              data-json-expect="list"
            ></textarea>
          </div>
          <div>
            <label for="task-kwargs">Kwargs (JSON object)</label>
            <div class="json-editor-actions">
              <button class="btn ghost btn-sm" type="button" data-json-format="task-kwargs">Format</button>
              <button class="btn ghost btn-sm" type="button" data-json-validate="task-kwargs">Validate</button>
              <span class="json-editor-status" data-json-status="task-kwargs" aria-live="polite"></span>
            </div>
            <textarea
              id="task-kwargs"
              name="kwargs"
              class="json-input"
              rows="6"
              placeholder='{"key": "value"}'
              data-json-expect="dict"
            ></textarea>
          </div>
        </div>
      </section>

      <div class="filter-actions">
        <button class="btn accent" type="submit" {% if not task_names %}disabled{% endif %}>Send task</button>
      </div>
    </form>
  </section>
{% endblock %}

{% block scripts %}
  {{ task_schemas|json_script:"task-schema-data" }}
  <script src="{% static 'js/task-form.js' %}" defer></script>
{% endblock %}
